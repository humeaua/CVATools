\documentclass{article}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{dsfont}
\usepackage{enumitem}
\usepackage{amsthm} % to enable the proofs
\usepackage{graphicx} % to enable the graphics
\usepackage{mathtools}

\usepackage{bbm}

\usepackage[hidelinks]{hyperref}

% to be read by all users : how to number theorems and definitions : 
% done by A. Humeau on 4/10/2012
\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{lemma}[theorem]{Lemma}

\newtheorem{definition}{Definition}[section]
\newtheorem{remark}{Remark}[section]
\newtheorem{example}{Example}[section]
\newtheorem{notation}{Notation}[section]

% end of environment addition

\usepackage{geometry}
\geometry{top=2cm, bottom=2cm, left=2cm, right=2cm}

\usepackage[utf8]{inputenc}

% to insert code in the report
\usepackage{listings}
\usepackage{xcolor}
\lstset { %
    language=C++,
    backgroundcolor=\color{white}, % set backgroundcolor
    basicstyle=\footnotesize,% basic font setting
}
%end of addition to insert code in the report

\bibliographystyle{plain}

\DeclareMathOperator*{\mysup}{sup}
\DeclareMathOperator*{\argmin}{argmin}

\begin{document}

\title{Stochastic Local Volatility}
\author{Alexandre Humeau}
\date{\today}
\maketitle

\section{The Model}
\subsection{General description}
Let $T$ be a finite time horizon (the final maturity of the deal we want to price, for example)
Let $S$ be an asset of drift $\mu_t$ under the domestic risk-neutral probability measure. We assume the following dynamics under $\mathbb{Q}_d$

\begin{equation}
	\frac{dS_t}{S_t} = \mu_t dt + \sigma(S_t,t) e^{X_t} dW_t
\end{equation}

\noindent where $(S,t) \mapsto \sigma(S,t)$ is the local volatility function (deterministic function of spot and time, calibrated to the vanilla option market at time $0$. We will develop later a methodology to calibrate that function $\sigma$. $X$ is an Ornstein-Ulhenbeck process so that : 

\begin{equation}
	\forall t \in [0,T], \mathbb{E}\left[e^{2X_t}\right] = 1
\end{equation}

\noindent The goal of the stochastic volatility would be to calibrate to the forward smile (to be consistent with the 

\subsection{Stochastic volatility part}
Let us assume that $X$ follows the following dynamics under the domestic risk-neutral probability measure

\begin{equation}
\begin{aligned}
	dX_t &= (\theta(t) - \lambda X_t) dt + \sigma_X dW_t^X\\
	X_0 &= 1
\end{aligned}
\end{equation}

\noindent The coefficients are kept constant for now for simplicity.

\noindent We have 

\begin{equation}
	X_t = e^{-\lambda t} + \int_{0}^t \theta(s) e^{-\lambda (t-s)} ds + \int_0^t \sigma_X e^{-\lambda(t-s)} dW_s^X
\end{equation}

\noindent Then,

\begin{equation*}
\begin{aligned}
	\exp\left(2e^{-\lambda t} + 2\int_{0}^t \theta(s) e^{-\lambda (t-s)} ds + 2\int_0^t \sigma_X^2 e^{-2\lambda(t-s)} ds\right) &= 1\\
	e^{-\lambda t} + \int_{0}^t \theta(s) e^{-\lambda (t-s)} ds + \int_0^t \sigma_X^2 e^{-2\lambda(t-s)} ds &= 0\\
	e^{-\lambda t} + \int_{0}^t \theta(s) e^{\lambda s} ds e^{-\lambda t} + \int_0^t \sigma_X^2 e^{-2\lambda(t-s)} ds &= 0\\
	-\lambda e^{-\lambda t} - \int_{0}^t \theta(s) e^{\lambda s} ds \lambda e^{-\lambda t} + 2 \sigma_X^2 e^{-2\lambda t} + \theta(t) &= 0
\end{aligned}
\end{equation*}

Setting $f(t) = \theta(t) e^{\lambda t}$ it yields

\begin{equation}
\begin{aligned}
	&\lambda \int_0^t f(s) ds + f(t) = c(t)\\
	&c(t) = \lambda - 2\sigma_X^2 e^{-\lambda t}
\end{aligned}
\end{equation}

\noindent Then $f$ satisfies the following ODE

\begin{equation}
\begin{aligned}
	& f'(t) + \lambda f(t) = -2 \sigma_X^2 \lambda e^{-\lambda t}\\
	&f(0) = \lambda - 2\sigma_X^2
\end{aligned}
\end{equation}

\noindent Then

\begin{equation}
\begin{aligned}
	f(t) &= Ce^{-\lambda t} - 2 \sigma_X^2 \lambda t e^{-\lambda t}\\
	&= \left(\lambda - 2\sigma_X^2 \right) e^{-\lambda t} - 2 \sigma_X^2 \lambda t e^{-\lambda t}\\
	f(t) &= \lambda e^{-\lambda t} - 2\sigma_X^2 (1 + \lambda t) e^{-\lambda t}
\end{aligned}
\end{equation}

\noindent Then

\begin{equation}
	\theta(t) = \lambda e^{-2\lambda t} -2 \sigma_X^2 (1 + \lambda t) e^{-2\lambda t}
\end{equation}

\noindent The stochastic volatility $X$ can be computed quite easily and be simulated exactly

\begin{equation}
	X_t \sim \mathcal{N}\left(e^{-\lambda t} + \int_0^t \theta(s) e^{-\lambda (t-s)} ds, \sigma^2 \frac{1 - e^{-2\lambda t}}{2\lambda}\right)
\end{equation}

\subsection{Calibration of the local volatility}

\begin{theorem}[Markovian Projection]
Put here the theorem of the markovian projection of general volatility models into a local volatility
\end{theorem}

\noindent In our case, we have

\begin{equation}
\begin{aligned}
	\sigma_D^2(x, t) &= \mathbb{E} \left[ e^{2X_t} \sigma^2(S_t, t) \middle| S_t = S\right]\\
	&= \mathbb{E}\left[e^{2X_t} \middle| S_t = S \right] \sigma^2(S,t)
\end{aligned}
\end{equation}

\subsubsection{Calibration via a PDE}
\noindent Let us introduce the Green function $G(S_0, X_0, t_0 ; S, X, t)$.  Let us set $b(X) = e^{X}$. $G$ satisfies

\begin{equation}
	\frac{\partial G}{\partial T} 
- \frac{1}{2} \frac{\partial^2}{\partial S^2} \left(\sigma^2 b^2 S^2 G\right) 
- \frac{\partial^2}{\partial X^2} \left( \sigma_X^2 G\right) 
- \frac{\partial^2}{\partial S \partial X} \left(\rho b \sigma S \sigma_X G \right) 
+ \frac{\partial }{\partial X}\left( (\theta - \lambda X) G\right) 
+ \frac{\partial }{\partial S}(\mu S G)
 = 0
\end{equation}

\noindent Let us assume (in relation of the previous section), that 
\begin{enumerate}
	\item $\sigma_X$, $\theta$ and $\lambda$ are not functions of $X$
	\item $\mu$ is not a function of S
	\item $\rho$ is neither a function of $S$ nor $X$
\end{enumerate}

\noindent The calibration PDE degenerates into 

\begin{equation}
	\frac{\partial G}{\partial T} 
- \frac{1}{2} e^{2X }\frac{\partial^2}{\partial S^2} \left(\sigma^2 S^2 G\right) 
- \sigma_X^2 \frac{\partial^2}{\partial X^2} \left( G\right) 
- \rho \frac{\partial^2}{\partial S \partial X} \left(b \sigma S \sigma_X G \right) 
+ \left(\theta - \lambda X\right) \frac{\partial }{\partial X}\left( G\right) 
+ \mu \frac{\partial }{\partial S}(S G)
 = 0
\end{equation}

\noindent Let us denote by $Q$ the density of $S$

\begin{equation}
	Q(S,t) = \int_\mathbb{R} G(S,X,t) dX
\end{equation}

\noindent Then

\begin{equation}
	\frac{\partial Q}{\partial t} - \frac{1}{2} \frac{\partial^2}{\partial S^2} \left(\sigma^2 S^2 \int_\mathbb{R} e^{2X} G(S,X,t) dX \right) + \mu \frac{\partial }{\partial S}(S G) = 0
\end{equation}

\noindent Thus,

\begin{equation}
	\frac{\partial Q}{\partial t} - \frac{1}{2} \frac{\partial^2}{\partial S^2} \left(\sigma^2  \frac{\int_\mathbb{R} e^{2X} G(S,X,t) dX}{\int_\mathbb{R} G(X,S,t) dX}S^2Q\right) + \mu \frac{\partial }{\partial S}(S G) = 0
\end{equation}

\noindent We recognize the Dupire equation which defines a local volatility function $\sigma_D(S,t)$

\begin{equation}
	\sigma_D^2(S,t) = \sigma^2(S,t) \frac{\int_\mathbb{R} e^{2X} G(S,X,t) dX}{\int_\mathbb{R} G(X,S,t) dX}
\end{equation}

\noindent which permits to re-write the calibration PDE

\begin{equation}
\begin{aligned}
\label{eq:SLVCalibrationPDE}
	&\frac{\partial G}{\partial T}
	- \frac{1}{2} \frac{\partial^2}{\partial S^2} \left(S^2 e^{2X} \sigma_D^2 \frac{\int_\mathbb{R} G(S,X,t) dX}{\int_\mathbb{R} e^{2X} G(S,X,t) dX}\right)
+ \mu \frac{\partial}{\partial S}\left( S G\right)
- \frac{\sigma_X^2}{2} \frac{\partial^2 G}{\partial X^2}
+ \frac{\partial }{\partial X} \left((\theta - \lambda X) G\right)\\
&- \rho \sigma_X \frac{\partial^2}{\partial S \partial X} \left(e^X S \sigma_D \sqrt{\frac{\int_\mathbb{R} G(S,X,t) dX}{\int_\mathbb{R} e^{2X} G(S,X,t) dX}} G\right) = 0
\end{aligned}
\end{equation}

The only SLV models tractables with a PDE calibration are then mono-asset SLV models. We will develop in the following another method which enable us to calibrate via Monte-Carlo SLV Models. However, a Monte-Carlo will have more noise than a PDE calibration.

\subsubsection{Calibration by Monte-Carlo}
In this section, we will develop a method to calibrate the SLV models in a higher dimension problem using a Monte-Carlo simulation.\\

\noindent Let us re-write the Dupire equation associated with the SLV model we just described

\begin{equation}
\begin{aligned}
	&\frac{\partial C}{\partial T} + P_d(0,T) \mathbb{E}^{\mathbb{Q}_T} \left[ \left(K r_d(T) - S_T r_f(T)\right) \textbf{1}_{\{S_T > K\}}\right] - \frac{1}{2} \sigma_D^2(K,T) K^2 \frac{\partial^2 C}{\partial K^2} = 0\\
	&\frac{\partial C}{\partial T} + P_d(0,T) \mathbb{E}^{\mathbb{Q}_T} \left[ \left(K r_d(T) - S_T r_f(T)\right) \textbf{1}_{\{S_T > K\}}\right] - \frac{1}{2} \sigma^2(K,T) \mathbb{E}\left[e^{2X_T}\middle| S_T=K\right] K^2 \frac{\partial^2 C}{\partial K^2} = 0\\
\end{aligned}
\end{equation}

\noindent To write the calibration equation, we are left with, the calculation of the following integral

\begin{equation}
	\mathbb{E}\left[e^{2X_T}\middle| S_T=K\right] = \frac{\mathbb{E}\left[e^{2X_T} \textbf{1}_{S_T=K}\right]}{\mathbb{P}(S_T = K)}
\end{equation}

\noindent Two Monte-Carlo method can then be used for the computation of this conditional expectation

\begin{enumerate}
	\item Estimation of the integral via a full Monte-Carlo simulation of $(S_T,X_T)$
	\item Approximation of the conditional expectation via a Least-Square approach using well-choosen polynomial functions
\end{enumerate}

\paragraph{Estimation via Least-Squares}
As we want to compute a $S_T$-measurable integral, we can approximate

\begin{equation}
	\mathbb{E}\left[e^{2X_T}\middle| S_T \right] \approx \sum_{m=1}^{M} \beta_m \zeta_m\left(S_T\right)
\end{equation}

\noindent where the coefficients $(\beta_1, \dots, \beta_M)$ are found by a least-square approach. Let us assume we have $N$ realisations of the random variables $(S_T,X_T)$ denoted by $\left((S_T^1,X_T^1),\dots, (S_T^N,X_T^N)\right)$

\noindent Let us write the minimization problem associated with Least-Square in our case. Let us set $\beta = \left(\beta_1, \dots, \beta_M\right)$

\begin{equation}
	\hat{\beta} = \argmin_{\beta \in \mathbb{R}^M}
\left\{\mathbb{E}\left[\left(\mathbb{E}\left[e^{2X_T} \middle| S_T\right] - \sum_{m=1}^M \beta_m \zeta_m\left(S_T\right)\right)^2\right]\right\}
\end{equation}

\noindent Denoting by $M_{\zeta \zeta}$ and $M_{\zeta X}$ the following quantities, according to \cite{Humeau2013}

\begin{equation}
\begin{aligned}
	(M_{\zeta \zeta})_{r,s} &= \mathbb{E}\left[\zeta_r(S_T)\zeta_s(S_T)\right]\\
	(M_{\zeta X})_r &= \mathbb{E}\left[\zeta_r(S_T)e^{2X_T}\right]
\end{aligned}
\end{equation}

\noindent we have the following estimation for the "regression coefficients" $\beta$

\begin{equation}	
	\beta = (M_{\zeta \zeta})^{-1} M_{\zeta X}
\end{equation}

\noindent Those quantities can be estimated using the Monte-Carlo paths

\begin{equation}
\begin{aligned}
	(\hat{M}_{\zeta \zeta})_{r,s} &= \frac{1}{N} \sum_{n=1}^N \zeta_r(S_T^n)\zeta_s(S_T^n)\\
	(\hat{M}_{\zeta X})_r &= \frac{1}{N} \sum_{n=1}^N \zeta_r(S_T^n)e^{2X_T^n}
\end{aligned}
\end{equation}

\noindent However, those estimations can be high-biased because the same paths are used to compute the regression coefficients are used to the conditional expectation.

\paragraph{Estimation via Monte-Carlo}

\section{Solving the SLV calibration PDE}
In this section we will develop numerical methods to solve equation (\ref{eq:SLVCalibrationPDE})

\begin{thebibliography}{9}

\bibitem{AbergelTachet2011}
  Frédéric Abergel, Rémi Tachet,
  \emph{A Non-linear integro-differential equation from Mathematical Finance},
  AIMS Journal,
  Version 1, 8th Sept. 2011

\bibitem{Humeau2013}
 Alexandre Humeau,
 \emph{Credit Valuation Adjustment},
 Master's thesis Ecole Centrale Paris
 Version 2, 
 1st November 2013

\bibitem{VanDerStoepGrzelakOosterlee2013}
 Anthonie W. Van Der Stoep, Lech A. Grzelak, Cornelis W. Oosterlee,
 \emph{The Heston Stochastic-Local volatility Model : Efficient Monte-Carlo simulation},
 Version 1, 11th June 2013

\end{thebibliography}

\end{document}
